{% extends "base.html" %}
{% block content %}
<div class="px-40 flex flex-1 justify-center py-5">
  <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
    <div class="flex flex-wrap justify-between gap-3 p-4"><p class="text-[#181111] tracking-light text-[32px] font-bold leading-tight min-w-72">Edit your listing</p></div>
    <form id="edit-listing-form">
      <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
        <label class="flex flex-col min-w-40 flex-1">
          <p class="text-[#181111] text-base font-medium leading-normal pb-2">Address</p>
          <input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#181111] focus:outline-0 focus:ring-0 border-none bg-[#f4f0f0] focus:border-none h-14 placeholder:text-[#886364] p-4 text-base font-normal leading-normal" name="address" value="{{ property.address }}" />
        </label>
      </div>
      <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
        <label class="flex flex-col min-w-40 flex-1">
          <p class="text-[#181111] text-base font-medium leading-normal pb-2">Description</p>
          <textarea class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#181111] focus:outline-0 focus:ring-0 border-none bg-[#f4f0f0] focus:border-none min-h-36 placeholder:text-[#886364] p-4 text-base font-normal leading-normal" name="description">{{ property.description }}</textarea>
        </label>
      </div>
      <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
        <label class="flex flex-col min-w-40 flex-1">
          <p class="text-[#181111] text-base font-medium leading-normal pb-2">Deposit</p>
          <input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#181111] focus:outline-0 focus:ring-0 border-none bg-[#f4f0f0] focus:border-none h-14 placeholder:text-[#886364] p-4 text-base font-normal leading-normal" name="deposit" value="{{ property.deposit }}" />
        </label>
      </div>
      <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
        <label class="flex flex-col min-w-40 flex-1">
          <p class="text-[#181111] text-base font-medium leading-normal pb-2">Square Footage</p>
          <input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#181111] focus:outline-0 focus:ring-0 border-none bg-[#f4f0f0] focus:border-none h-14 placeholder:text-[#886364] p-4 text-base font-normal leading-normal" name="sqft" value="{{ property.sqft }}" />
        </label>
      </div>
      <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
        <label class="flex flex-col min-w-40 flex-1">
          <p class="text-[#181111] text-base font-medium leading-normal pb-2">Lease Term</p>
          <select class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#181111] focus:outline-0 focus:ring-0 border-none bg-[#f4f0f0] focus:border-none h-14 bg-[image:--select-button-svg] placeholder:text-[#886364] p-4 text-base font-normal leading-normal" name="lease_length">
            <option value="12 months" {% if property.lease_length == '12 months' %}selected{% endif %}>12 months</option>
            <option value="6 months" {% if property.lease_length == '6 months' %}selected{% endif %}>6 months</option>
            <option value="month-to-month" {% if property.lease_length == 'month-to-month' %}selected{% endif %}>Month-to-month</option>
          </select>
        </label>
      </div>
      <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
        <label class="flex flex-col min-w-40 flex-1">
          <p class="text-[#181111] text-base font-medium leading-normal pb-2">Rental Rate</p>
          <input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#181111] focus:outline-0 focus:ring-0 border-none bg-[#f4f0f0] focus:border-none h-14 placeholder:text-[#886364] p-4 text-base font-normal leading-normal" name="rent" value="{{ property.rent }}" />
        </label>
      </div>
      <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
        <label class="flex flex-col min-w-40 flex-1">
          <p class="text-[#181111] text-base font-medium leading-normal pb-2">Pet Allowed</p>
          <select class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#181111] focus:outline-0 focus:ring-0 border-none bg-[#f4f0f0] focus:border-none h-14 bg-[image:--select-button-svg] placeholder:text-[#886364] p-4 text-base font-normal leading-normal" name="pets_allowed">
            <option value="Yes" {% if property.pets_allowed == 'Yes' %}selected{% endif %}>Yes</option>
            <option value="No" {% if property.pets_allowed == 'No' %}selected{% endif %}>No</option>
            <option value="Unknown" {% if property.pets_allowed == 'Unknown' %}selected{% endif %}>Unknown</option>
          </select>
        </label>
      </div>
      <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
        <label class="flex flex-col min-w-40 flex-1">
          <p class="text-[#181111] text-base font-medium leading-normal pb-2">Number of Bedrooms</p>
          <input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#181111] focus:outline-0 focus:ring-0 border-none bg-[#f4f0f0] focus:border-none h-14 placeholder:text-[#886364] p-4 text-base font-normal leading-normal" name="bedrooms" value="{{ property.bedrooms }}" />
        </label>
      </div>
      <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
        <label class="flex flex-col min-w-40 flex-1">
          <p class="text-[#181111] text-base font-medium leading-normal pb-2">Number of Bathrooms</p>
          <input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#181111] focus:outline-0 focus:ring-0 border-none bg-[#f4f0f0] focus:border-none h-14 placeholder:text-[#886364] p-4 text-base font-normal leading-normal" name="bathrooms" value="{{ property.bathrooms }}" />
        </label>
      </div>
      <h3 class="text-[#181111] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Amenities</h3>
      <div class="px-4 py-3">
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
          {% set common_amenities = [
            'Air Conditioning', 'Heating', 'Dishwasher', 'Microwave', 'Refrigerator',
            'Washer/Dryer', 'Washer/Dryer Hookup', 'Balcony/Deck', 'Parking', 'Gym', 'Pool',
            'Pet Friendly', 'Furnished', 'Hardwood Floors', 'Walk-in Closet',
            'In-unit Laundry', 'Central Air', 'Fireplace', 'Garden', 'Storage',
            'Snow Removal', 'Lawn Mowing Service', 'Common Area Cleaning Service'
          ] %}
          
          {% set normalized_amenities = (property.included_amenities | default([])) | map('lower') | map('trim') | list %}
          
          {% set amenity_aliases = {
            'Air Conditioning': ['air conditioning', 'ac', 'a/c'],
            'Heating': ['heating', 'heat'],
            'Dishwasher': ['dishwasher'],
            'Microwave': ['microwave'],
            'Refrigerator': ['refrigerator', 'fridge'],
            'Washer/Dryer': ['washer/dryer', 'washer dryer', 'laundry'],
            'Washer/Dryer Hookup': ['washer/dryer hookup', 'washer dryer hookup', 'laundry hookup'],
            'Balcony/Deck': ['balcony', 'deck', 'balcony/deck'],
            'Parking': ['parking', 'garage', 'carport'],
            'Gym': ['gym', 'fitness', 'fitness center'],
            'Pool': ['pool', 'swimming pool'],
            'Pet Friendly': ['pet friendly', 'pets allowed', 'pets ok', 'pet'],
            'Furnished': ['furnished'],
            'Hardwood Floors': ['hardwood floors', 'wood floors', 'hardwood'],
            'Walk-in Closet': ['walk-in closet', 'walk in closet', 'walkin closet'],
            'In-unit Laundry': ['in-unit laundry', 'in unit laundry', 'laundry in unit'],
            'Central Air': ['central air', 'central a/c', 'central ac'],
            'Fireplace': ['fireplace'],
            'Garden': ['garden', 'yard'],
            'Storage': ['storage', 'storage unit'],
            'Snow Removal': ['snow removal', 'snow'],
            'Lawn Mowing Service': ['lawn mowing service', 'lawn service', 'lawn care', 'mowing', 'landscaping'],
            'Common Area Cleaning Service': ['common area cleaning service', 'common area cleaning', 'cleaning service'],
            'Water': ['water'],
            'Trash': ['trash', 'garbage', 'refuse'],
            'Sewer': ['sewer', 'sewage']
          } %}
          
          {% for amenity in common_amenities %}
            {% set norm = amenity|lower|trim %}
            {% set aliases = (amenity_aliases[amenity] if amenity in amenity_aliases else [amenity]) %}
            {% set aliases = aliases + [amenity] %}
            {% set aliases = aliases | map('lower') | map('trim') | list %}
            <label class="flex items-center space-x-2 cursor-pointer">
              <input type="checkbox" name="amenities" value="{{ amenity }}" 
                     class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
                     {% if aliases|select('in', normalized_amenities)|list|length > 0 %}checked{% endif %}>
              <span class="text-[#181111] text-sm">{{ amenity }}</span>
            </label>
          {% endfor %}
        </div>
        
        <!-- Custom amenities input -->
        <div class="mt-4">
          <label class="block text-[#181111] text-sm font-medium mb-2">Custom Amenities (comma-separated)</label>
          <input type="text" name="custom_amenities" 
                 class="w-full p-2 border border-gray-300 rounded-md bg-[#f4f0f0] text-[#181111]"
                 placeholder="e.g., Rooftop access, Bike storage, Concierge"
                 value="{{ property.custom_amenities or '' }}">
        </div>
      </div>
      <h3 class="text-[#181111] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Photos</h3>
      <div class="px-4 py-3">
        <div class="flex justify-between items-center mb-4">
          <span class="text-sm text-gray-600">Click photos to select/deselect. Selected photos will be deleted when you save.</span>
          <button type="button" id="select-all-btn" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Select All</button>
        </div>
        
          <div id="photo-grid" class="w-full gap-2 overflow-y-auto overflow-x-hidden bg-white rounded-xl grid grid-cols-3 aspect-[3/2] max-h-[420px] scrollbar-thin scrollbar-thumb-blue-300 scrollbar-track-blue-50" style="scrollbar-width: thin;">
    {% for img in property.photos %}
      <div class="photo-item relative w-full bg-center bg-no-repeat bg-cover aspect-square rounded-lg cursor-pointer border-2 border-transparent hover:border-blue-400 transition-all" 
           style="background-image: url('{{ img }}');" 
           data-image-url="{{ img }}">
        <div class="absolute top-2 right-2 w-6 h-6 bg-white rounded-full flex items-center justify-center opacity-0 photo-checkbox">
          <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all rounded-lg"></div>
      </div>
    {% endfor %}
  </div>
        
        <div class="flex gap-2 mt-4">
          <form id="image-upload-form" enctype="multipart/form-data" class="flex items-center">
            <input type="file" id="image-upload-input" name="file" accept="image/*" multiple style="display:none;" />
            <button type="button" id="add-image-btn" class="flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 gap-2 text-sm font-medium">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256">
                <path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"></path>
              </svg>
              Add Images
            </button>
          </form>
          
          <button type="button" id="delete-selected-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium opacity-50" disabled>
            Delete Selected
          </button>
        </div>
      </div>
      <div class="flex px-4 py-3 justify-end">
        <button id="save-changes-btn" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#e82630] text-white text-sm font-bold leading-normal tracking-[0.015em]">
          <span class="truncate">Save Changes</span>
        </button>
      </div>
    </form>
  </div>
</div>
<div id="save-toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 bg-green-600 text-white px-6 py-3 rounded shadow-lg text-lg font-semibold opacity-0 pointer-events-none transition-opacity duration-300">
  Changes have been saved!
</div>
<script>
  // Photo management and form submission
  document.addEventListener('DOMContentLoaded', function() {
    const saveBtn = document.getElementById('save-changes-btn');
    const form = document.getElementById('edit-listing-form');
    const photoGrid = document.getElementById('photo-grid');
    const selectAllBtn = document.getElementById('select-all-btn');
    const deleteSelectedBtn = document.getElementById('delete-selected-btn');
    const addImageBtn = document.getElementById('add-image-btn');
    const imageInput = document.getElementById('image-upload-input');
    
    let selectedPhotos = new Set();
    
    // Photo selection functionality
    function updatePhotoSelection() {
      const photoItems = document.querySelectorAll('.photo-item');
      photoItems.forEach(item => {
        const checkbox = item.querySelector('.photo-checkbox');
        const imageUrl = item.dataset.imageUrl;
        
        if (selectedPhotos.has(imageUrl)) {
          item.classList.add('border-blue-500', 'bg-blue-50');
          checkbox.classList.remove('opacity-0');
        } else {
          item.classList.remove('border-blue-500', 'bg-blue-50');
          checkbox.classList.add('opacity-0');
        }
      });
      
      // Update delete button state
      deleteSelectedBtn.disabled = selectedPhotos.size === 0;
      deleteSelectedBtn.classList.toggle('opacity-50', selectedPhotos.size === 0);
    }
    
    // Photo click handler
    if (photoGrid) {
      photoGrid.addEventListener('click', function(e) {
        const photoItem = e.target.closest('.photo-item');
        if (photoItem) {
          const imageUrl = photoItem.dataset.imageUrl;
          if (selectedPhotos.has(imageUrl)) {
            selectedPhotos.delete(imageUrl);
          } else {
            selectedPhotos.add(imageUrl);
          }
          updatePhotoSelection();
        }
      });
    }
    
    // Select all functionality
    if (selectAllBtn) {
      selectAllBtn.addEventListener('click', function() {
        const photoItems = document.querySelectorAll('.photo-item');
        if (selectedPhotos.size === photoItems.length) {
          // Deselect all
          selectedPhotos.clear();
          selectAllBtn.textContent = 'Select All';
        } else {
          // Select all
          photoItems.forEach(item => {
            selectedPhotos.add(item.dataset.imageUrl);
          });
          selectAllBtn.textContent = 'Deselect All';
        }
        updatePhotoSelection();
      });
    }
    
    // Delete selected photos
    if (deleteSelectedBtn) {
      deleteSelectedBtn.addEventListener('click', function() {
        if (selectedPhotos.size === 0) return;
        
        if (confirm(`Are you sure you want to delete ${selectedPhotos.size} photo(s)?`)) {
          selectedPhotos.forEach(imageUrl => {
            const photoItem = document.querySelector(`[data-image-url="${imageUrl}"]`);
            if (photoItem) {
              photoItem.remove();
            }
          });
          selectedPhotos.clear();
          updatePhotoSelection();
        }
      });
    }
    
    // Form submission with photo management
    if (form && saveBtn) {
      saveBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        
        // Add selected photos for deletion
        formData.append('photos_to_delete', JSON.stringify(Array.from(selectedPhotos)));
        
        fetch(`{{ url_for('save_edit', id=property_id) }}`, {
          method: 'POST',
          body: formData
        })
        .then(res => {
          if (res.redirected) {
            // Show toast before redirect
            showSaveToast();
            setTimeout(() => { window.location.href = res.url; }, 900);
          } else {
            showSaveToast();
            return res.text();
          }
        })
        .catch(err => alert('Error saving changes: ' + err));
      });
    }
    
    // Enhanced image upload functionality
    if (addImageBtn && imageInput) {
      addImageBtn.addEventListener('click', function(e) {
        imageInput.click();
      });
      
      imageInput.addEventListener('change', function(e) {
        if (imageInput.files.length > 0) {
          Array.from(imageInput.files).forEach(file => {
            const uploadData = new FormData();
            uploadData.append('file', file);
            
            fetch(`/upload-image/{{ property_id }}`, {
              method: 'POST',
              body: uploadData
            })
            .then(res => res.json())
            .then(data => {
              if (data.success && data.new_image_url) {
                // Add new image to photo grid
                const div = document.createElement('div');
                div.className = 'photo-item relative w-full bg-center bg-no-repeat bg-cover aspect-square rounded-lg cursor-pointer border-2 border-transparent hover:border-blue-400 transition-all';
                div.style.backgroundImage = `url('${data.new_image_url}')`;
                div.dataset.imageUrl = data.new_image_url;
                
                div.innerHTML = `
                  <div class="absolute top-2 right-2 w-6 h-6 bg-white rounded-full flex items-center justify-center opacity-0 photo-checkbox">
                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                  </div>
                  <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all rounded-lg"></div>
                `;
                
                photoGrid.appendChild(div);
              } else {
                alert('Image upload failed.');
              }
            })
            .catch(err => alert('Image upload error: ' + err));
          });
          
          // Clear the input
          imageInput.value = '';
        }
      });
    }
  });

  // Toast popup logic
  function showSaveToast() {
    const toast = document.getElementById('save-toast');
    if (toast) {
      toast.classList.remove('opacity-0', 'pointer-events-none');
      toast.classList.add('opacity-100');
      setTimeout(() => {
        toast.classList.add('opacity-0', 'pointer-events-none');
        toast.classList.remove('opacity-100');
      }, 1200);
    }
  }
</script>
{% endblock %}
        <div class="px-40 flex flex-1 justify-center py-5">
          <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
            <div class="flex flex-wrap justify-between gap-3 p-4"><p class="text-[#181111] tracking-light text-[32px] font-bold leading-tight min-w-72">Edit your listing</p></div>
            <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
              <label class="flex flex-col min-w-40 flex-1">
                <p class="text-[#181111] text-base font-medium leading-normal pb-2">Address</p>
                <input
                  class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#181111] focus:outline-0 focus:ring-0 border-none bg-[#f4f0f0] focus:border-none h-14 placeholder:text-[#886364] p-4 text-base font-normal leading-normal"
                  name="address"
                  value="{{ property.address }}"
                />
              </label>
            </div>
            <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
              <label class="flex flex-col min-w-40 flex-1">
                <p class="text-[#181111] text-base font-medium leading-normal pb-2">Description</p>
                <textarea
                  class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#181111] focus:outline-0 focus:ring-0 border-none bg-[#f4f0f0] focus:border-none min-h-36 placeholder:text-[#886364] p-4 text-base font-normal leading-normal"
                  name="description"
                >{{ property.description }}</textarea>
              </label>
            </div>
            <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
              <label class="flex flex-col min-w-40 flex-1">
                <p class="text-[#181111] text-base font-medium leading-normal pb-2">Deposit</p>
                <input
                  class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#181111] focus:outline-0 focus:ring-0 border-none bg-[#f4f0f0] focus:border-none h-14 placeholder:text-[#886364] p-4 text-base font-normal leading-normal"
                  name="deposit"
                  value="{{ property.deposit }}"
                />
              </label>
            </div>
            <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
              <label class="flex flex-col min-w-40 flex-1">
                <p class="text-[#181111] text-base font-medium leading-normal pb-2">Square Footage</p>
                <input
                  class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#181111] focus:outline-0 focus:ring-0 border-none bg-[#f4f0f0] focus:border-none h-14 placeholder:text-[#886364] p-4 text-base font-normal leading-normal"
                  name="sqft"
                  value="{{ property.sqft }}"
                />
              </label>
            </div>
            <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
              <label class="flex flex-col min-w-40 flex-1">
                <p class="text-[#181111] text-base font-medium leading-normal pb-2">Lease Term</p>
                <select
                  class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#181111] focus:outline-0 focus:ring-0 border-none bg-[#f4f0f0] focus:border-none h-14 bg-[image:--select-button-svg] placeholder:text-[#886364] p-4 text-base font-normal leading-normal"
                  name="lease_length"
                >
                  <option value="12 months" {% if property.lease_length == '12 months' %}selected{% endif %}>12 months</option>
                  <option value="6 months" {% if property.lease_length == '6 months' %}selected{% endif %}>6 months</option>
                  <option value="month-to-month" {% if property.lease_length == 'month-to-month' %}selected{% endif %}>Month-to-month</option>
                </select>
              </label>
            </div>
            <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
              <label class="flex flex-col min-w-40 flex-1">
                <p class="text-[#181111] text-base font-medium leading-normal pb-2">Rental Rate</p>
                <input
                  class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#181111] focus:outline-0 focus:ring-0 border-none bg-[#f4f0f0] focus:border-none h-14 placeholder:text-[#886364] p-4 text-base font-normal leading-normal"
                  name="rent"
                  value="{{ property.rent }}"
                />
              </label>
            </div>
            <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
              <label class="flex flex-col min-w-40 flex-1">
                <p class="text-[#181111] text-base font-medium leading-normal pb-2">Pet Allowed</p>
                <select
                  class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#181111] focus:outline-0 focus:ring-0 border-none bg-[#f4f0f0] focus:border-none h-14 bg-[image:--select-button-svg] placeholder:text-[#886364] p-4 text-base font-normal leading-normal"
                  name="pets_allowed"
                >
                  <option value="Yes" {% if property.pets_allowed == 'Yes' %}selected{% endif %}>Yes</option>
                  <option value="No" {% if property.pets_allowed == 'No' %}selected{% endif %}>No</option>
                  <option value="Unknown" {% if property.pets_allowed == 'Unknown' %}selected{% endif %}>Unknown</option>
                </select>
              </label>
            </div>
            <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
              <label class="flex flex-col min-w-40 flex-1">
                <p class="text-[#181111] text-base font-medium leading-normal pb-2">Number of Bedrooms</p>
                <input
                  class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#181111] focus:outline-0 focus:ring-0 border-none bg-[#f4f0f0] focus:border-none h-14 placeholder:text-[#886364] p-4 text-base font-normal leading-normal"
                  name="bedrooms"
                  value="{{ property.bedrooms }}"
                />
              </label>
            </div>
            <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
              <label class="flex flex-col min-w-40 flex-1">
                <p class="text-[#181111] text-base font-medium leading-normal pb-2">Number of Bathrooms</p>
                <input
                  class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#181111] focus:outline-0 focus:ring-0 border-none bg-[#f4f0f0] focus:border-none h-14 placeholder:text-[#886364] p-4 text-base font-normal leading-normal"
                  name="bathrooms"
                  value="{{ property.bathrooms }}"
                />
              </label>
            </div>
            <h3 class="text-[#181111] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Amenities</h3>
            <div class="px-4">
              <label class="flex gap-x-3 py-3 flex-row">
                <input
                  type="checkbox"
                  class="h-5 w-5 rounded border-[#e5dcdc] border-2 bg-transparent text-[#e82630] checked:bg-[#e82630] checked:border-[#e82630] checked:bg-[image:--checkbox-tick-svg] focus:ring-0 focus:ring-offset-0 focus:border-[#e5dcdc] focus:outline-none"
                  checked=""
                />
                <p class="text-[#181111] text-base font-normal leading-normal">Wi-Fi</p>
              </label>
              <label class="flex gap-x-3 py-3 flex-row">
                <input
                  type="checkbox"
                  class="h-5 w-5 rounded border-[#e5dcdc] border-2 bg-transparent text-[#e82630] checked:bg-[#e82630] checked:border-[#e82630] checked:bg-[image:--checkbox-tick-svg] focus:ring-0 focus:ring-offset-0 focus:border-[#e5dcdc] focus:outline-none"
                  checked=""
                />
                <p class="text-[#181111] text-base font-normal leading-normal">Air Conditioning</p>
              </label>
              <label class="flex gap-x-3 py-3 flex-row">
                <input
                  type="checkbox"
                  class="h-5 w-5 rounded border-[#e5dcdc] border-2 bg-transparent text-[#e82630] checked:bg-[#e82630] checked:border-[#e82630] checked:bg-[image:--checkbox-tick-svg] focus:ring-0 focus:ring-offset-0 focus:border-[#e5dcdc] focus:outline-none"
                  checked=""
                />
                <p class="text-[#181111] text-base font-normal leading-normal">Heating</p>
              </label>
              <label class="flex gap-x-3 py-3 flex-row">
                <input
                  type="checkbox"
                  class="h-5 w-5 rounded border-[#e5dcdc] border-2 bg-transparent text-[#e82630] checked:bg-[#e82630] checked:border-[#e82630] checked:bg-[image:--checkbox-tick-svg] focus:ring-0 focus:ring-offset-0 focus:border-[#e5dcdc] focus:outline-none"
                />
                <p class="text-[#181111] text-base font-normal leading-normal">Washer</p>
              </label>
              <label class="flex gap-x-3 py-3 flex-row">
                <input
                  type="checkbox"
                  class="h-5 w-5 rounded border-[#e5dcdc] border-2 bg-transparent text-[#e82630] checked:bg-[#e82630] checked:border-[#e82630] checked:bg-[image:--checkbox-tick-svg] focus:ring-0 focus:ring-offset-0 focus:border-[#e5dcdc] focus:outline-none"
                />
                <p class="text-[#181111] text-base font-normal leading-normal">Dryer</p>
              </label>
              <label class="flex gap-x-3 py-3 flex-row">
                <input
                  type="checkbox"
                  class="h-5 w-5 rounded border-[#e5dcdc] border-2 bg-transparent text-[#e82630] checked:bg-[#e82630] checked:border-[#e82630] checked:bg-[image:--checkbox-tick-svg] focus:ring-0 focus:ring-offset-0 focus:border-[#e5dcdc] focus:outline-none"
                />
                <p class="text-[#181111] text-base font-normal leading-normal">Washer Dryer Hookup</p>
              </label>
              <label class="flex gap-x-3 py-3 flex-row">
                <input
                  type="checkbox"
                  class="h-5 w-5 rounded border-[#e5dcdc] border-2 bg-transparent text-[#e82630] checked:bg-[#e82630] checked:border-[#e82630] checked:bg-[image:--checkbox-tick-svg] focus:ring-0 focus:ring-offset-0 focus:border-[#e5dcdc] focus:outline-none"
                />
                <p class="text-[#181111] text-base font-normal leading-normal">Pool</p>
              </label>
              <label class="flex gap-x-3 py-3 flex-row">
                <input
                  type="checkbox"
                  class="h-5 w-5 rounded border-[#e5dcdc] border-2 bg-transparent text-[#e82630] checked:bg-[#e82630] checked:border-[#e82630] checked:bg-[image:--checkbox-tick-svg] focus:ring-0 focus:ring-offset-0 focus:border-[#e5dcdc] focus:outline-none"
                />
                <p class="text-[#181111] text-base font-normal leading-normal">Snow Removal</p>
              </label>
              <label class="flex gap-x-3 py-3 flex-row">
                <input
                  type="checkbox"
                  class="h-5 w-5 rounded border-[#e5dcdc] border-2 bg-transparent text-[#e82630] checked:bg-[#e82630] checked:border-[#e82630] checked:bg-[image:--checkbox-tick-svg] focus:ring-0 focus:ring-offset-0 focus:border-[#e5dcdc] focus:outline-none"
                />
                <p class="text-[#181111] text-base font-normal leading-normal">Lawn Mowing Service</p>
              </label>
              <label class="flex gap-x-3 py-3 flex-row">
                <input
                  type="checkbox"
                  class="h-5 w-5 rounded border-[#e5dcdc] border-2 bg-transparent text-[#e82630] checked:bg-[#e82630] checked:border-[#e82630] checked:bg-[image:--checkbox-tick-svg] focus:ring-0 focus:ring-offset-0 focus:border-[#e5dcdc] focus:outline-none"
                />
                <p class="text-[#181111] text-base font-normal leading-normal">Common Area Cleaning Service</p>
              </label>
            </div>
            <h3 class="text-[#181111] text-lg font-bold leading-tight tracking-[-0.015em] px-4 pb-2 pt-4">Photos</h3>
            <div class="flex w-full grow bg-white @container p-4">
              <div class="w-full gap-1 overflow-hidden bg-white @[480px]:gap-2 aspect-[3/2] rounded-xl grid grid-cols-[2fr_1fr_1fr]">
                {% for img in property.photos %}
                  <div class="w-full bg-center bg-no-repeat bg-cover aspect-auto rounded-none" style="background-image: url('{{ img }}');"></div>
                {% endfor %}
              </div>
            </div>
            <div class="flex px-4 py-3 justify-start">
              <form id="image-upload-form" enctype="multipart/form-data" class="flex items-center">
                <input type="file" id="image-upload-input" name="file" accept="image/*" style="display:none;" />
                <button type="button"
                  id="add-image-btn"
                  class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#f4f0f0] text-[#181111] gap-2 pl-4 text-sm font-bold leading-normal tracking-[0.015em]"
                >
                  <div class="text-[#181111]" data-icon="Plus" data-size="20px" data-weight="regular">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
                      <path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"></path>
                    </svg>
                  </div>
                  <span class="truncate">Add Images</span>
                </button>
              </form>
            </div>
            <div class="flex px-4 py-3 justify-end">
              <button
                id="save-changes-btn"
                class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#e82630] text-white text-sm font-bold leading-normal tracking-[0.015em]"
              >
                <span class="truncate">Save Changes</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      // AJAX form submission for auto-update
      document.addEventListener('DOMContentLoaded', function() {
        const saveBtn = document.getElementById('save-changes-btn');
        const form = saveBtn.closest('form') || document.querySelector('form');
        if (form) {
          form.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(form);
            fetch(`{{ url_for('save_edit', id=property_id) }}`, {
              method: 'POST',
              body: formData
            })
            .then(res => {
              if (res.redirected) {
                window.location.href = res.url;
              } else {
                return res.text();
              }
            })
            .catch(err => alert('Error saving changes: ' + err));
          });
        }

        // Add Images button functionality
        const addImageBtn = document.getElementById('add-image-btn');
        const imageInput = document.getElementById('image-upload-input');
        const imageForm = document.getElementById('image-upload-form');
        addImageBtn.addEventListener('click', function(e) {
          imageInput.click();
        });
        imageInput.addEventListener('change', function(e) {
          if (imageInput.files.length > 0) {
            const file = imageInput.files[0];
            const uploadData = new FormData();
            uploadData.append('file', file);
            fetch(`/upload-image/{{ property_id }}`, {
              method: 'POST',
              body: uploadData
            })
            .then(res => res.json())
            .then(data => {
              if (data.success && data.new_image_url) {
                // Add new image to photo grid
                const photoGrid = document.querySelector('.grid.grid-cols-[2fr_1fr_1fr]');
                if (photoGrid) {
                  const div = document.createElement('div');
                  div.className = 'w-full bg-center bg-no-repeat bg-cover aspect-auto rounded-none';
                  div.style.backgroundImage = `url('${data.new_image_url}')`;
                  photoGrid.appendChild(div);
                }
              } else {
                alert('Image upload failed.');
              }
            })
            .catch(err => alert('Image upload error: ' + err));
          }
        });
      });
    </script>
  </body>
</html>
